<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DirectoryServiceImp.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Coverage with Unit Tests</a> &gt; <a href="../index.html" class="el_bundle">service</a> &gt; <a href="index.source.html" class="el_package">org.ehrbase.service</a> &gt; <span class="el_source">DirectoryServiceImp.java</span></div><h1>DirectoryServiceImp.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2022 vitasystems GmbH and Hannover Medical School.
 *
 * This file is part of project EHRbase
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.ehrbase.service;

import com.nedap.archie.rm.directory.Folder;
import com.nedap.archie.rm.support.identification.HierObjectId;
import com.nedap.archie.rm.support.identification.ObjectVersionId;
import com.nedap.archie.rm.support.identification.UID;
import com.nedap.archie.rm.support.identification.UIDBasedId;
import com.nedap.archie.rm.support.identification.VersionTreeId;
import java.time.OffsetDateTime;
import java.util.List;
import java.util.Optional;
import java.util.UUID;
import javax.annotation.Nullable;
import org.apache.commons.lang3.ArrayUtils;
import org.apache.commons.lang3.StringUtils;
import org.ehrbase.api.definitions.ServerConfig;
import org.ehrbase.api.exception.ObjectNotFoundException;
import org.ehrbase.api.exception.PreconditionFailedException;
import org.ehrbase.api.exception.StateConflictException;
import org.ehrbase.api.service.EhrService;
import org.ehrbase.dao.access.util.FolderUtils;
import org.ehrbase.jooq.pg.tables.records.EhrFolderHistoryRecord;
import org.ehrbase.jooq.pg.tables.records.EhrFolderRecord;
import org.ehrbase.repository.EhrFolderRepository;
import org.ehrbase.util.UuidGenerator;
import org.jooq.DSLContext;
import org.jooq.Result;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

/**
 * @author Stefan Spiska
 */
@Service
@Transactional
public class DirectoryServiceImp extends BaseServiceImp implements InternalDirectoryService {

    private final ServerConfig serverConfig;
    private final EhrService ehrService;

    private final EhrFolderRepository ehrFolderRepository;

    public DirectoryServiceImp(
            KnowledgeCacheService knowledgeCacheService,
            DSLContext context,
            ServerConfig serverConfig,
            EhrService ehrService,
            EhrFolderRepository ehrFolderRepository) {
<span class="nc" id="L67">        super(knowledgeCacheService, context, serverConfig);</span>
<span class="nc" id="L68">        this.serverConfig = serverConfig;</span>
<span class="nc" id="L69">        this.ehrService = ehrService;</span>
<span class="nc" id="L70">        this.ehrFolderRepository = ehrFolderRepository;</span>
<span class="nc" id="L71">    }</span>

    @Override
    public Optional&lt;Folder&gt; get(UUID ehrId, @Nullable ObjectVersionId folderId, @Nullable String path) {

        List&lt;EhrFolderRecord&gt; ehrFolderRecords;
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (folderId == null) {</span>
<span class="nc" id="L78">            ehrFolderRecords = ehrFolderRepository.getFolderHead(ehrId, 1);</span>

<span class="nc" id="L80">        } else {</span>
<span class="nc" id="L81">            VersionTreeId versionTreeId = folderId.getVersionTreeId();</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">            if (versionTreeId.isBranch()) {</span>
<span class="nc" id="L83">                throw new UnsupportedOperationException(</span>
<span class="nc" id="L84">                        &quot;Version branching is not supported: %s&quot;.formatted(versionTreeId.getValue()));</span>
            }
            // check creating system matches
<span class="nc bnc" id="L87" title="All 2 branches missed.">            if (!folderId.getCreatingSystemId().getValue().equals(serverConfig.getNodename())) {</span>
<span class="nc" id="L88">                return Optional.empty();</span>
            }
<span class="nc" id="L90">            int version = Integer.parseInt(versionTreeId.getValue());</span>

<span class="nc" id="L92">            Result&lt;EhrFolderHistoryRecord&gt; byVersion = ehrFolderRepository.getByVersion(ehrId, version);</span>
<span class="nc" id="L93">            ehrFolderRecords = ehrFolderRepository.fromHistory(byVersion);</span>
        }

<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (ehrFolderRecords.isEmpty()) {</span>
            // Check if EHR for the folder exists
<span class="nc" id="L98">            ehrService.checkEhrExists(ehrId);</span>
<span class="nc" id="L99">            return Optional.empty();</span>
        }

<span class="nc" id="L102">        Folder root = ehrFolderRepository.from(ehrFolderRecords);</span>

        // check if id matches
<span class="nc bnc" id="L105" title="All 4 branches missed.">        if (folderId != null &amp;&amp; !folderId.getRoot().equals(root.getUid().getRoot())) {</span>
<span class="nc" id="L106">            return Optional.empty();</span>
        }

<span class="nc" id="L109">        return findByPath(root, StringUtils.split(path, '/'));</span>
    }

    @Override
    public Optional&lt;Folder&gt; getByTime(UUID ehrId, OffsetDateTime time, @Nullable String path) {
<span class="nc" id="L114">        List&lt;EhrFolderRecord&gt; ehrFolderRecords =</span>
<span class="nc" id="L115">                ehrFolderRepository.fromHistory(ehrFolderRepository.getByTime(ehrId, time));</span>

<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (ehrFolderRecords.isEmpty()) {</span>
<span class="nc" id="L118">            return Optional.empty();</span>
        }
<span class="nc" id="L120">        return findByPath(ehrFolderRepository.from(ehrFolderRecords), StringUtils.split(path, '/'));</span>
    }

    private Optional&lt;Folder&gt; findByPath(Folder root, String[] path) {

<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (ArrayUtils.isEmpty(path)) {</span>
<span class="nc" id="L126">            return Optional.of(root);</span>
        }
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (root.getFolders() == null) {</span>
<span class="nc" id="L129">            return Optional.empty();</span>
        }

<span class="nc" id="L132">        return root.getFolders().stream()</span>
<span class="nc" id="L133">                .filter(sf -&gt; sf.getNameAsString().equals(path[0]))</span>
<span class="nc" id="L134">                .findAny()</span>
<span class="nc" id="L135">                .flatMap(sf -&gt; findByPath(sf, ArrayUtils.subarray(path, 1, path.length)));</span>
    }

    @Override
    public Folder create(UUID ehrId, Folder folder) {

<span class="nc" id="L141">        return create(ehrId, folder, null, null);</span>
    }

    @Override
    public Folder create(UUID ehrId, Folder folder, UUID contributionId, UUID auditId) {

        // validation
<span class="nc" id="L148">        ehrService.checkEhrExistsAndIsModifiable(ehrId);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (ehrFolderRepository.hasDirectory(ehrId)) {</span>
<span class="nc" id="L150">            throw new StateConflictException(&quot;EHR with id %s already contains a directory.&quot;.formatted(ehrId));</span>
        }

<span class="nc" id="L153">        FolderUtils.checkSiblingNameConflicts(folder);</span>

<span class="nc" id="L155">        updateUuid(</span>
<span class="nc" id="L156">                folder,</span>
<span class="nc" id="L157">                true,</span>
<span class="nc" id="L158">                Optional.ofNullable(folder.getUid())</span>
<span class="nc" id="L159">                        .map(UIDBasedId::getRoot)</span>
<span class="nc" id="L160">                        .map(UID::getValue)</span>
<span class="nc" id="L161">                        .map(UUID::fromString)</span>
<span class="nc" id="L162">                        .orElse(UuidGenerator.randomUUID()),</span>
<span class="nc" id="L163">                1);</span>

<span class="nc" id="L165">        ehrFolderRepository.commit(ehrFolderRepository.toRecord(ehrId, folder), contributionId, auditId);</span>

<span class="nc" id="L167">        return get(ehrId, null, null).get();</span>
    }

    @Override
    public Folder update(UUID ehrId, Folder folder, ObjectVersionId ifMatches) {

<span class="nc" id="L173">        return update(ehrId, folder, ifMatches, null, null);</span>
    }

    @Override
    public Folder update(UUID ehrId, Folder folder, ObjectVersionId ifMatches, UUID contributionId, UUID auditId) {
        // validation
<span class="nc" id="L179">        ehrService.checkEhrExistsAndIsModifiable(ehrId);</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (!ehrFolderRepository.hasDirectory(ehrId)) {</span>
<span class="nc" id="L181">            throw new PreconditionFailedException(</span>
<span class="nc" id="L182">                    String.format(&quot;EHR with id %s does not contain a directory.&quot;, ehrId.toString()));</span>
        }

<span class="nc" id="L185">        FolderUtils.checkSiblingNameConflicts(folder);</span>

<span class="nc" id="L187">        int version = Integer.parseInt(ifMatches.getVersionTreeId().getValue());</span>
<span class="nc" id="L188">        updateUuid(folder, true, UUID.fromString(ifMatches.getObjectId().getValue()), version + 1);</span>
<span class="nc" id="L189">        ehrFolderRepository.update(ehrFolderRepository.toRecord(ehrId, folder), contributionId, auditId);</span>

<span class="nc" id="L191">        return get(ehrId, null, null).get();</span>
    }

    @Override
    public void delete(UUID ehrId, ObjectVersionId ifMatches) {

<span class="nc" id="L197">        delete(ehrId, ifMatches, null, null);</span>
<span class="nc" id="L198">    }</span>

    @Override
    public void delete(UUID ehrId, ObjectVersionId ifMatches, UUID contributionId, UUID auditId) {

        // validation
<span class="nc" id="L204">        ehrService.checkEhrExistsAndIsModifiable(ehrId);</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (!ehrFolderRepository.hasDirectory(ehrId)) {</span>
<span class="nc" id="L206">            throw new PreconditionFailedException(&quot;EHR with id %s does not contain a directory.&quot;.formatted(ehrId));</span>
        }

<span class="nc" id="L209">        ehrFolderRepository.delete(</span>
<span class="nc" id="L210">                ehrId,</span>
<span class="nc" id="L211">                UUID.fromString(ifMatches.getObjectId().getValue()),</span>
<span class="nc" id="L212">                Integer.parseInt(ifMatches.getVersionTreeId().getValue()),</span>
<span class="nc" id="L213">                1,</span>
<span class="nc" id="L214">                contributionId,</span>
<span class="nc" id="L215">                auditId);</span>
<span class="nc" id="L216">    }</span>

    private void updateUuid(Folder folder, boolean root, UUID rootUuid, int version) {

<span class="nc bnc" id="L220" title="All 4 branches missed.">        if (folder.getUid() == null || root) {</span>

<span class="nc bnc" id="L222" title="All 2 branches missed.">            if (root) {</span>
<span class="nc" id="L223">                folder.setUid(new ObjectVersionId(rootUuid + &quot;::&quot; + serverConfig.getNodename() + &quot;::&quot; + version));</span>
<span class="nc" id="L224">            } else {</span>
<span class="nc" id="L225">                folder.setUid(new HierObjectId(UuidGenerator.randomUUID().toString()));</span>
            }
        }

<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (folder.getFolders() != null) {</span>

<span class="nc" id="L231">            folder.getFolders().forEach(folder1 -&gt; updateUuid(folder1, false, rootUuid, version));</span>
        }
<span class="nc" id="L233">    }</span>

    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    @Override
    public void adminDeleteFolder(UUID ehrId, UUID folderId) {

        // Check if EHR exists
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (!this.ehrService.hasEhr(ehrId)) {</span>
<span class="nc" id="L241">            throw new ObjectNotFoundException(&quot;Admin Directory&quot;, &quot;EHR with id %s does not exist&quot;.formatted(ehrId));</span>
        }

        // For now only EHR.directory is supported
<span class="nc" id="L245">        Result&lt;EhrFolderRecord&gt; latest = ehrFolderRepository.getFolderHead(ehrId, 1);</span>

<span class="nc bnc" id="L247" title="All 2 branches missed.">        if (latest.isNotEmpty()) {</span>
<span class="nc" id="L248">            Folder from = ehrFolderRepository.from(latest);</span>

<span class="nc bnc" id="L250" title="All 2 branches missed.">            if (!UUID.fromString(from.getUid().getRoot().getValue()).equals(folderId)) {</span>
<span class="nc" id="L251">                throw new IllegalArgumentException(&quot;FolderIds do not match&quot;);</span>
            }

<span class="nc" id="L254">            ehrFolderRepository.adminDelete(ehrId, 1);</span>
        }
<span class="nc" id="L256">    }</span>

    @Override
    public List&lt;ObjectVersionId&gt; findForContribution(UUID ehrId, UUID contributionId) {

<span class="nc" id="L261">        return ehrFolderRepository.findForContribution(ehrId, contributionId);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>