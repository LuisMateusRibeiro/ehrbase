<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>LateralJoins.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Coverage with Unit Tests</a> &gt; <a href="../index.html" class="el_bundle">service</a> &gt; <a href="index.source.html" class="el_package">org.ehrbase.aql.sql.binding</a> &gt; <span class="el_source">LateralJoins.java</span></div><h1>LateralJoins.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2020-2022 vitasystems GmbH and Hannover Medical School.
 *
 * This file is part of project EHRbase
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.ehrbase.aql.sql.binding;

import org.ehrbase.aql.definition.I_VariableDefinition;
import org.ehrbase.aql.definition.LateralJoinDefinition;
import org.ehrbase.aql.definition.LateralVariable;
import org.ehrbase.aql.sql.queryimpl.IQueryImpl;
import org.jooq.JoinType;
import org.jooq.Record;
import org.jooq.SelectQuery;
import org.jooq.SelectSelectStep;
import org.jooq.Table;
import org.jooq.impl.DSL;

/**
 * @author Christian Chevalley
 * @since 1.0
 */
public class LateralJoins {

<span class="fc" id="L37">    private static int seed = 1;</span>

    private LateralJoins() {
        // NOOP
    }

    public static void create(
            String templateId, TaggedStringBuilder encodedVar, I_VariableDefinition item, IQueryImpl.Clause clause) {
<span class="fc" id="L45">        var originalSqlExpression = encodedVar.toString();</span>

<span class="pc bpc" id="L47" title="1 of 2 branches missed.">        if (originalSqlExpression.isBlank()) return;</span>

        // check for existing lateral join in the SAME variable definition
<span class="pc bpc" id="L50" title="1 of 2 branches missed.">        if (item.getLateralJoinDefinitions(templateId) != null</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">                &amp;&amp; !item.getLateralJoinDefinitions(templateId).isEmpty()) {</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">            for (LateralJoinDefinition lateralJoinDefinition : item.getLateralJoinDefinitions(templateId)) {</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">                if (lateralJoinDefinition.getSqlExpression().equals(originalSqlExpression)) {</span>
                    // use this definition instead of creating a new redundant one
<span class="nc" id="L55">                    item.setAlias(new LateralVariable(</span>
<span class="nc" id="L56">                                    lateralJoinDefinition.getTable().getName(),</span>
<span class="nc" id="L57">                                    lateralJoinDefinition.getLateralVariable())</span>
<span class="nc" id="L58">                            .alias());</span>
<span class="nc" id="L59">                    return;</span>
                }
<span class="nc" id="L61">            }</span>
        }

<span class="fc" id="L64">        int hashValue = encodedVar.toString().hashCode(); // cf. SonarLint</span>
        int abs;
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">        if (hashValue != 0) abs = Math.abs(hashValue);</span>
<span class="nc" id="L67">        else abs = 0;</span>
<span class="fc" id="L68">        String tableAlias = &quot;array_&quot; + abs + &quot;_&quot; + inc();</span>
<span class="fc" id="L69">        String variableAlias = &quot;var_&quot; + abs + &quot;_&quot; + inc();</span>
        // insert the variable alias used for the lateral join expression
<span class="fc" id="L71">        encodedVar.replaceLast(&quot;)&quot;, &quot; AS &quot; + variableAlias + &quot;)&quot;);</span>
<span class="fc" id="L72">        Table&lt;Record&gt; table = DSL.table(encodedVar.toString()).as(tableAlias);</span>

<span class="fc" id="L74">        LateralJoinDefinition lateralJoinDefinition =</span>
                new LateralJoinDefinition(originalSqlExpression, table, variableAlias, JoinType.JOIN, null, clause);
<span class="fc" id="L76">        reuse(lateralJoinDefinition, templateId, item);</span>
<span class="fc" id="L77">    }</span>

    public static void create(
            String templateId, SelectQuery selectSelectStep, I_VariableDefinition item, IQueryImpl.Clause clause) {
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">        if (selectSelectStep == null) return;</span>
<span class="fc" id="L82">        int hashValue = selectSelectStep.hashCode(); // cf. SonarLint</span>
        int abs;
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">        if (hashValue != 0) abs = Math.abs(hashValue);</span>
<span class="nc" id="L85">        else abs = 0;</span>
<span class="fc" id="L86">        String tableAlias = &quot;array_&quot; + abs + &quot;_&quot; + inc();</span>
<span class="fc" id="L87">        String variableAlias = &quot;var_&quot; + abs + &quot;_&quot; + inc();</span>

<span class="fc" id="L89">        SelectSelectStep wrappedSelectSelectStep =</span>
<span class="fc" id="L90">                DSL.select(DSL.field(selectSelectStep).as(variableAlias));</span>

<span class="fc" id="L92">        Table&lt;Record&gt; table = DSL.table(wrappedSelectSelectStep).as(tableAlias);</span>
<span class="fc" id="L93">        item.setLateralJoinTable(</span>
                templateId,
                new LateralJoinDefinition(
<span class="fc" id="L96">                        selectSelectStep.getSQL(),</span>
                        table,
                        variableAlias,
                        JoinType.LEFT_OUTER_JOIN,
<span class="fc" id="L100">                        DSL.condition(true),</span>
                        clause));
<span class="fc" id="L102">        item.setSubstituteFieldVariable(variableAlias);</span>
<span class="fc" id="L103">    }</span>

    public static void reuse(
            LateralJoinDefinition lateralJoinDefinition, String templateId, I_VariableDefinition item) {
<span class="fc" id="L107">        item.setLateralJoinTable(templateId, lateralJoinDefinition);</span>
<span class="fc" id="L108">        item.setAlias(new LateralVariable(</span>
<span class="fc" id="L109">                        lateralJoinDefinition.getTable().getName(), lateralJoinDefinition.getLateralVariable())</span>
<span class="fc" id="L110">                .alias());</span>
<span class="fc" id="L111">    }</span>

    private static synchronized int inc() {
<span class="fc" id="L114">        return seed++;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>