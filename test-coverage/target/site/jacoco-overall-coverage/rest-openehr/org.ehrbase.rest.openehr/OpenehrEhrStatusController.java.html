<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>OpenehrEhrStatusController.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Overall Coverage</a> &gt; <a href="../index.html" class="el_bundle">rest-openehr</a> &gt; <a href="index.source.html" class="el_package">org.ehrbase.rest.openehr</a> &gt; <span class="el_source">OpenehrEhrStatusController.java</span></div><h1>OpenehrEhrStatusController.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2019-2022 vitasystems GmbH and Hannover Medical School.
 *
 * This file is part of project EHRbase
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.ehrbase.rest.openehr;

import static org.apache.commons.lang3.StringUtils.unwrap;

import com.nedap.archie.rm.changecontrol.OriginalVersion;
import com.nedap.archie.rm.ehr.EhrStatus;
import java.net.URI;
import java.sql.Timestamp;
import java.time.OffsetDateTime;
import java.util.Arrays;
import java.util.List;
import java.util.Optional;
import java.util.UUID;
import java.util.function.Supplier;
import org.ehrbase.api.annotations.TenantAware;
import org.ehrbase.api.audit.msg.AuditMsgBuilder;
import org.ehrbase.api.authorization.EhrbaseAuthorization;
import org.ehrbase.api.authorization.EhrbasePermission;
import org.ehrbase.api.exception.InternalServerException;
import org.ehrbase.api.exception.InvalidApiParameterException;
import org.ehrbase.api.exception.ObjectNotFoundException;
import org.ehrbase.api.exception.PreconditionFailedException;
import org.ehrbase.api.service.EhrService;
import org.ehrbase.openehr.sdk.response.dto.EhrStatusResponseData;
import org.ehrbase.rest.BaseController;
import org.ehrbase.rest.openehr.specification.EhrStatusApiSpecification;
import org.ehrbase.rest.util.InternalResponse;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

/**
 * Controller for /ehr/{ehrId}/ehr_status resource of openEHR REST API
 *
 * @author Jake Smolka
 * @author Renaud Subiger
 * @since 1.0
 */
@TenantAware
@RestController
@RequestMapping(path = BaseController.API_CONTEXT_PATH_WITH_VERSION + &quot;/ehr/{ehr_id}/ehr_status&quot;)
public class OpenehrEhrStatusController extends BaseController implements EhrStatusApiSpecification {

    private final EhrService ehrService;

<span class="nc" id="L73">    public OpenehrEhrStatusController(EhrService ehrService) {</span>
<span class="nc" id="L74">        this.ehrService = ehrService;</span>
<span class="nc" id="L75">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    @GetMapping
    @EhrbaseAuthorization(permission = EhrbasePermission.EHRBASE_EHR_READ_STATUS)
    @PreAuthorize(&quot;checkAbacPre(@openehrEhrStatusController.EHR_STATUS, @ehrService.getSubjectExtRef(#ehrId))&quot;)
    public ResponseEntity&lt;EhrStatusResponseData&gt; getEhrStatusVersionByTime(
            @PathVariable(name = &quot;ehr_id&quot;) UUID ehrId,
            @RequestParam(name = &quot;version_at_time&quot;, required = false) String versionAtTime,
            @RequestHeader(name = HttpHeaders.ACCEPT, required = false) String accept) {

<span class="nc" id="L89">        assertEhrExists(ehrId);</span>

        // timestamp optional, otherwise latest
        int version;
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (versionAtTime != null) {</span>
<span class="nc" id="L94">            OffsetDateTime time = OffsetDateTime.parse(versionAtTime);</span>
<span class="nc" id="L95">            Timestamp timestamp = Timestamp.valueOf(time.toLocalDateTime());</span>
<span class="nc" id="L96">            version = ehrService.getEhrStatusVersionByTimestamp(ehrId, timestamp);</span>
<span class="nc" id="L97">        } else {</span>
<span class="nc" id="L98">            version = Integer.parseInt(</span>
<span class="nc" id="L99">                    ehrService.getLatestVersionUidOfStatus(ehrId).split(&quot;::&quot;)[2]);</span>
        }

<span class="nc" id="L102">        UUID statusUid = ehrService.getEhrStatusVersionedObjectUidByEhr(ehrId);</span>

<span class="nc" id="L104">        return internalGetEhrStatusProcessing(accept, ehrId, statusUid, version);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    @GetMapping(path = &quot;/{version_uid}&quot;)
    @EhrbaseAuthorization(permission = EhrbasePermission.EHRBASE_EHR_READ_STATUS)
    @PreAuthorize(&quot;checkAbacPre(@openehrEhrStatusController.EHR_STATUS, @ehrService.getSubjectExtRef(#ehrId))&quot;)
    public ResponseEntity&lt;EhrStatusResponseData&gt; getEhrStatusByVersionId(
            @PathVariable(name = &quot;ehr_id&quot;) UUID ehrId,
            @PathVariable(name = &quot;version_uid&quot;) String versionUid,
            @RequestHeader(name = HttpHeaders.ACCEPT, required = false) String accept) {

<span class="nc" id="L119">        assertEhrExists(ehrId);</span>

<span class="nc" id="L121">        UUID versionedObjectUid = extractVersionedObjectUidFromVersionUid(versionUid);</span>
<span class="nc" id="L122">        int version = extractVersionFromVersionUid(versionUid);</span>

<span class="nc" id="L124">        Optional&lt;OriginalVersion&lt;EhrStatus&gt;&gt; ehrStatus =</span>
<span class="nc" id="L125">                ehrService.getEhrStatusAtVersion(ehrId, versionedObjectUid, version);</span>

<span class="nc" id="L127">        UUID ehrStatusId = extractVersionedObjectUidFromVersionUid(ehrStatus</span>
<span class="nc" id="L128">                .orElseThrow(() -&gt; new ObjectNotFoundException(&quot;ehr_status&quot;, &quot;EHR_STATUS not found&quot;))</span>
<span class="nc" id="L129">                .getUid()</span>
<span class="nc" id="L130">                .toString());</span>

<span class="nc" id="L132">        return internalGetEhrStatusProcessing(accept, ehrId, ehrStatusId, version);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    @PutMapping
    @EhrbaseAuthorization(permission = EhrbasePermission.EHRBASE_EHR_UPDATE_STATUS)
    @PreAuthorize(&quot;checkAbacPre(@openehrEhrStatusController.EHR_STATUS, @ehrService.getSubjectExtRef(#ehrId))&quot;)
    public ResponseEntity&lt;EhrStatusResponseData&gt; updateEhrStatus(
            @PathVariable(&quot;ehr_id&quot;) UUID ehrId,
            @RequestHeader(name = IF_MATCH) String versionUid,
            @RequestHeader(name = PREFER, required = false) String prefer,
            @RequestHeader(name = HttpHeaders.ACCEPT, required = false) String accept,
            @RequestHeader(name = HttpHeaders.CONTENT_TYPE, required = false) String contentType,
            @RequestBody EhrStatus ehrStatus) {

<span class="nc" id="L150">        assertEhrExists(ehrId);</span>

        // If-Match header check
<span class="nc" id="L153">        String latestVersionUid = ehrService.getLatestVersionUidOfStatus(ehrId);</span>
<span class="nc" id="L154">        versionUid = unwrap(versionUid, '&quot;');</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (!latestVersionUid.equals(versionUid)) {</span>
<span class="nc" id="L156">            throw new PreconditionFailedException(&quot;Given If-Match header does not match latest existing version&quot;);</span>
        }

        // update EHR_STATUS and check for success
<span class="nc" id="L160">        UUID statusUid = ehrService.updateStatus(ehrId, ehrStatus, null, null);</span>

        // update and prepare current version number
<span class="nc" id="L163">        String newLatestVersionUid = ehrService.getLatestVersionUidOfStatus(ehrId);</span>
<span class="nc" id="L164">        String[] split = latestVersionUid.split(&quot;::&quot;);</span>
<span class="nc bnc" id="L165" title="All 4 branches missed.">        if (latestVersionUid.equals(newLatestVersionUid) || split.length != 3) {</span>
<span class="nc" id="L166">            throw new InvalidApiParameterException(&quot;Update of EHR_STATUS failed&quot;);</span>
        }
<span class="nc" id="L168">        int version = Integer.parseInt(split[split.length - 1]) + 1;</span>

<span class="nc" id="L170">        List&lt;String&gt; headerList =</span>
<span class="nc" id="L171">                Arrays.asList(CONTENT_TYPE, LOCATION, ETAG, LAST_MODIFIED); // whatever is required by REST spec</span>
        Optional&lt;InternalResponse&lt;EhrStatusResponseData&gt;&gt;
                respData; // variable to overload with more specific object if requested

<span class="nc" id="L175">        respData =</span>
<span class="nc" id="L176">                buildEhrStatusResponseData(EhrStatusResponseData::new, ehrId, statusUid, version, accept, headerList);</span>

<span class="nc" id="L178">        createAuditLogsMsgBuilder(ehrId);</span>

<span class="nc" id="L180">        return respData.map(i -&gt; ResponseEntity.ok().headers(i.getHeaders()).body(i.getResponseData()))</span>
<span class="nc" id="L181">                .orElse(ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build());</span>
    }

    /**
     * Assert that an EHR with the given ID exists.
     *
     * @param ehrId the EHR ID to check
     * @throws ObjectNotFoundException if the EHR does not exist
     */
    private void assertEhrExists(UUID ehrId) {
<span class="nc bnc" id="L191" title="All 2 branches missed.">        if (!ehrService.hasEhr(ehrId)) {</span>
<span class="nc" id="L192">            throw new ObjectNotFoundException(&quot;EHR&quot;, &quot;The EHR with the specified id does not exist&quot;);</span>
        }
<span class="nc" id="L194">    }</span>

    private ResponseEntity&lt;EhrStatusResponseData&gt; internalGetEhrStatusProcessing(
            String accept, UUID ehrId, UUID ehrStatusId, int version) {
<span class="nc" id="L198">        List&lt;String&gt; headerList =</span>
<span class="nc" id="L199">                Arrays.asList(CONTENT_TYPE, LOCATION, ETAG, LAST_MODIFIED); // whatever is required by REST spec</span>

<span class="nc" id="L201">        Optional&lt;InternalResponse&lt;EhrStatusResponseData&gt;&gt; respData =</span>
<span class="nc" id="L202">                buildEhrStatusResponseData(EhrStatusResponseData::new, ehrId, ehrStatusId, version, accept, headerList);</span>

<span class="nc" id="L204">        createAuditLogsMsgBuilder(ehrId);</span>

<span class="nc" id="L206">        return respData.map(i -&gt; ResponseEntity.ok().headers(i.getHeaders()).body(i.getResponseData()))</span>
<span class="nc" id="L207">                .orElse(ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build());</span>
    }

    private void createAuditLogsMsgBuilder(UUID ehrId) {
<span class="nc" id="L211">        AuditMsgBuilder.getInstance().setEhrIds(ehrId);</span>
<span class="nc" id="L212">    }</span>

    /**
     * Builder method to prepare appropriate HTTP response. Flexible to either allow minimal or full
     * representation of resource.
     *
     * @param factory     Lambda function to constructor of desired object
     * @param ehrId       Ehr reference
     * @param ehrStatusId EhrStatus versioned object ID
     * @param version     EhrStatus version number
     * @param accept      Requested content format
     * @param headerList  Requested headers that need to be set
     * @param &lt;T&gt;         Either only header response or specific class EhrStatusResponseData
     * @return
     */
    private &lt;T extends EhrStatusResponseData&gt; Optional&lt;InternalResponse&lt;T&gt;&gt; buildEhrStatusResponseData(
            Supplier&lt;T&gt; factory, UUID ehrId, UUID ehrStatusId, int version, String accept, List&lt;String&gt; headerList) {
        // create either EhrStatusResponseData or null (means no body, only headers incl. link to resource), via lambda
        // request
<span class="nc" id="L231">        T minimalOrRepresentation = factory.get();</span>

        // check for valid format header to produce content accordingly
<span class="nc" id="L234">        MediaType contentType = resolveContentType(accept); // to prepare header input if this header is needed later</span>

<span class="nc" id="L236">        Optional&lt;OriginalVersion&lt;EhrStatus&gt;&gt; ehrStatus = ehrService.getEhrStatusAtVersion(ehrId, ehrStatusId, version);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (minimalOrRepresentation != null) {</span>
            // when this &quot;if&quot; is true the following casting can be executed and data manipulated by reference (handled
            // by temporary variable)
<span class="nc" id="L240">            EhrStatusResponseData objByReference = minimalOrRepresentation;</span>

<span class="nc bnc" id="L242" title="All 2 branches missed.">            if (ehrStatus.isPresent()) {</span>
<span class="nc" id="L243">                objByReference.setArchetypeNodeId(ehrStatus.get().getData().getArchetypeNodeId());</span>
<span class="nc" id="L244">                objByReference.setName(ehrStatus.get().getData().getName());</span>
<span class="nc" id="L245">                objByReference.setUid(ehrStatus.get().getUid());</span>
<span class="nc" id="L246">                objByReference.setSubject(ehrStatus.get().getData().getSubject());</span>
<span class="nc" id="L247">                objByReference.setOtherDetails(ehrStatus.get().getData().getOtherDetails());</span>
<span class="nc" id="L248">                objByReference.setModifiable(ehrStatus.get().getData().isModifiable());</span>
<span class="nc" id="L249">                objByReference.setQueryable(ehrStatus.get().getData().isQueryable());</span>
            } else {
<span class="nc" id="L251">                return Optional.empty();</span>
            }
        }

        // create and supplement headers with data depending on which headers are requested
<span class="nc" id="L256">        HttpHeaders respHeaders = new HttpHeaders();</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">        for (String header : headerList) {</span>
<span class="nc bnc" id="L258" title="All 5 branches missed.">            switch (header) {</span>
                case CONTENT_TYPE:
<span class="nc" id="L260">                    respHeaders.setContentType(contentType);</span>
<span class="nc" id="L261">                    break;</span>
                case LOCATION:
                    try {
<span class="nc" id="L264">                        URI url = createLocationUri(</span>
                                EHR,
<span class="nc" id="L266">                                ehrId.toString(),</span>
                                EHR_STATUS,
<span class="nc" id="L268">                                String.format(</span>
                                        &quot;%s::%s::%s&quot;,
                                        ehrStatusId,
<span class="nc" id="L271">                                        ehrService.getServerConfig().getNodename(),</span>
<span class="nc" id="L272">                                        version));</span>
<span class="nc" id="L273">                        respHeaders.setLocation(url);</span>
<span class="nc" id="L274">                    } catch (Exception e) {</span>
<span class="nc" id="L275">                        throw new InternalServerException(e.getMessage());</span>
<span class="nc" id="L276">                    }</span>
                    break;
                case ETAG:
<span class="nc" id="L279">                    respHeaders.setETag(&quot;\&quot;&quot; + ehrStatusId + &quot;::&quot;</span>
<span class="nc" id="L280">                            + ehrService.getServerConfig().getNodename() + &quot;::&quot; + version + &quot;\&quot;&quot;);</span>
<span class="nc" id="L281">                    break;</span>
                case LAST_MODIFIED:
<span class="nc" id="L283">                    ehrStatus.ifPresent(ehrStatusOriginalVersion -&gt; respHeaders.setLastModified(ehrStatusOriginalVersion</span>
<span class="nc" id="L284">                            .getCommitAudit()</span>
<span class="nc" id="L285">                            .getTimeCommitted()</span>
<span class="nc" id="L286">                            .getMagnitude()));</span>
<span class="nc" id="L287">                    break;</span>
                default:
                    // Ignore header
            }
<span class="nc" id="L291">        }</span>

<span class="nc" id="L293">        return Optional.of(new InternalResponse&lt;&gt;(minimalOrRepresentation, respHeaders));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>