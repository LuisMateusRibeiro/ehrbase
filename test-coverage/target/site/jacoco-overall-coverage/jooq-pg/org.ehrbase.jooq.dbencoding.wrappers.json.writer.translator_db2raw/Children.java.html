<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Children.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Overall Coverage</a> &gt; <a href="../index.html" class="el_bundle">jooq-pg</a> &gt; <a href="index.source.html" class="el_package">org.ehrbase.jooq.dbencoding.wrappers.json.writer.translator_db2raw</a> &gt; <span class="el_source">Children.java</span></div><h1>Children.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2019 vitasystems GmbH and Hannover Medical School.
 *
 * This file is part of project EHRbase
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.ehrbase.jooq.dbencoding.wrappers.json.writer.translator_db2raw;

import com.google.gson.internal.LinkedTreeMap;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;
import org.ehrbase.jooq.dbencoding.CompositionSerializer;
import org.ehrbase.jooq.dbencoding.wrappers.json.I_DvTypeAdapter;

/** Created by christian on 3/13/2018. */
public class Children {

    LinkedTreeMap&lt;String, Object&gt; linkedTreeMap;

<span class="fc" id="L33">    public Children(LinkedTreeMap&lt;String, Object&gt; linkedTreeMap) {</span>
<span class="fc" id="L34">        this.linkedTreeMap = linkedTreeMap;</span>
<span class="fc" id="L35">    }</span>

    public boolean isItemsOnly() {

<span class="fc" id="L39">        if (linkedTreeMap.keySet().stream()</span>
<span class="fc" id="L40">                        .filter(s -&gt; s.startsWith(CompositionSerializer.TAG_ITEMS))</span>
<span class="fc" id="L41">                        .collect(Collectors.toSet())</span>
<span class="fc bfc" id="L42" title="All 2 branches covered.">                        .size()</span>
<span class="fc" id="L43">                == 0) return false;</span>

<span class="fc bfc" id="L45" title="All 2 branches covered.">        for (String key : linkedTreeMap.keySet()) {</span>
<span class="fc bfc" id="L46" title="All 2 branches covered.">            if (!key.startsWith(CompositionSerializer.TAG_ITEMS)</span>
<span class="fc bfc" id="L47" title="All 2 branches covered.">                    &amp;&amp; !key.equals(I_DvTypeAdapter.ARCHETYPE_NODE_ID)</span>
<span class="fc bfc" id="L48" title="All 2 branches covered.">                    &amp;&amp; !key.equals(I_DvTypeAdapter.AT_CLASS)</span>
<span class="fc bfc" id="L49" title="All 2 branches covered.">                    &amp;&amp; !isTrivialLocatableAttribute(key)</span>
<span class="fc bfc" id="L50" title="All 2 branches covered.">                    &amp;&amp; !key.equals(CompositionSerializer.TAG_CLASS)) {</span>
<span class="fc" id="L51">                return false;</span>
            }
<span class="fc" id="L53">        }</span>
<span class="fc" id="L54">        return true;</span>
    }

    private static boolean isTrivialLocatableAttribute(String key) {
<span class="fc bfc" id="L58" title="All 2 branches covered.">        return (key.equals(CompositionSerializer.TAG_ARCHETYPE_NODE_ID)</span>
<span class="fc bfc" id="L59" title="All 2 branches covered.">                || key.equals(CompositionSerializer.TAG_ARCHETYPE_DETAILS)</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">                || key.equals(CompositionSerializer.TAG_NAME));</span>
    }

    public int itemsCount() {
<span class="nc" id="L64">        int count = 0;</span>

<span class="nc bnc" id="L66" title="All 2 branches missed.">        for (String key : linkedTreeMap.keySet()) {</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">            if (key.startsWith(CompositionSerializer.TAG_ITEMS)) count++;</span>
<span class="nc" id="L68">        }</span>
<span class="nc" id="L69">        return count;</span>
    }

    public int eventsCount() {
<span class="nc" id="L73">        int count = 0;</span>

<span class="nc bnc" id="L75" title="All 2 branches missed.">        for (String key : linkedTreeMap.keySet()) {</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">            if (key.startsWith(CompositionSerializer.TAG_EVENTS)) count++;</span>
<span class="nc" id="L77">        }</span>
<span class="nc" id="L78">        return count;</span>
    }

    // check for multiple items in content
    public boolean isMultiContent() {

<span class="fc bfc" id="L84" title="All 2 branches covered.">        if (!containsKeyStartingWith(CompositionSerializer.TAG_CONTENT)) return false;</span>

<span class="fc" id="L86">        int contents = 0;</span>

<span class="fc bfc" id="L88" title="All 2 branches covered.">        for (String key : linkedTreeMap.keySet()) {</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">            if (key.startsWith(CompositionSerializer.TAG_CONTENT)) {</span>
<span class="fc" id="L90">                contents++;</span>
            }
<span class="fc" id="L92">        }</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">        return contents &gt; 1;</span>
    }

    public int contentCount() {
<span class="nc" id="L97">        int contents = 0;</span>

<span class="nc bnc" id="L99" title="All 2 branches missed.">        for (String key : linkedTreeMap.keySet()) {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">            if (key.startsWith(CompositionSerializer.TAG_CONTENT)) {</span>
<span class="nc" id="L101">                contents++;</span>
            }
<span class="nc" id="L103">        }</span>
<span class="nc" id="L104">        return contents;</span>
    }

    public boolean isMultiData() {
<span class="nc" id="L108">        int data = 0;</span>

<span class="nc bnc" id="L110" title="All 2 branches missed.">        for (String key : linkedTreeMap.keySet()) {</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            if (key.startsWith(CompositionSerializer.TAG_DATA)) {</span>
<span class="nc" id="L112">                data++;</span>
            }
<span class="nc" id="L114">        }</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        return data &gt; 1;</span>
    }

    public boolean isEvents() {
<span class="fc" id="L119">        if (linkedTreeMap.keySet().stream()</span>
<span class="fc" id="L120">                        .filter(s -&gt; s.startsWith(CompositionSerializer.TAG_EVENTS))</span>
<span class="fc" id="L121">                        .collect(Collectors.toSet())</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">                        .size()</span>
<span class="fc" id="L123">                == 0) return false;</span>

<span class="fc" id="L125">        int isEvents = 0;</span>

<span class="fc bfc" id="L127" title="All 2 branches covered.">        for (String key : linkedTreeMap.keySet()) {</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">            if (key.startsWith(CompositionSerializer.TAG_EVENTS)) {</span>
<span class="fc" id="L129">                isEvents++;</span>
            }
<span class="fc" id="L131">        }</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">        return isEvents &gt; 1;</span>
    }

    public String type() {

<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (linkedTreeMap.containsKey(CompositionSerializer.TAG_CLASS)) {</span>
<span class="nc" id="L138">            return (String) linkedTreeMap.get(CompositionSerializer.TAG_CLASS);</span>
        }

<span class="nc" id="L141">        return &quot;*UNDEF*&quot;;</span>
    }

    public ArrayList items() {

<span class="fc" id="L146">        ArrayList items = new ArrayList();</span>

<span class="fc bfc" id="L148" title="All 2 branches covered.">        for (String key : linkedTreeMap.keySet()) {</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">            if (key.startsWith(CompositionSerializer.TAG_ITEMS)) {</span>
<span class="fc" id="L150">                String archetypeNodeId = new NodeId(key).predicate();</span>
<span class="fc" id="L151">                Object e = linkedTreeMap.get(key);</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">                if (List.class.isAssignableFrom(e.getClass())) {</span>
<span class="fc" id="L153">                    ((List) e)</span>
<span class="fc" id="L154">                            .stream()</span>
<span class="fc" id="L155">                                    .filter(o -&gt; Map.class.isAssignableFrom(o.getClass()))</span>
<span class="fc" id="L156">                                    .forEach(m -&gt; ((Map) m).put(I_DvTypeAdapter.ARCHETYPE_NODE_ID, archetypeNodeId));</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">                } else if (Map.class.isAssignableFrom(e.getClass())) {</span>
<span class="fc" id="L158">                    ((Map) e).put(I_DvTypeAdapter.ARCHETYPE_NODE_ID, archetypeNodeId);</span>
                }
<span class="fc" id="L160">                items.add(e);</span>
            }
<span class="fc" id="L162">        }</span>

<span class="fc" id="L164">        return items;</span>
    }

    public ArrayList events() {

<span class="fc" id="L169">        ArrayList events = new ArrayList();</span>

<span class="fc bfc" id="L171" title="All 2 branches covered.">        for (String key : linkedTreeMap.keySet()) {</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">            if (key.startsWith(CompositionSerializer.TAG_EVENTS)) events.add(linkedTreeMap.get(key));</span>
<span class="fc" id="L173">        }</span>

<span class="fc" id="L175">        return events;</span>
    }

    public ArrayList contents() {
<span class="fc" id="L179">        ArrayList contents = new ArrayList();</span>

<span class="fc bfc" id="L181" title="All 2 branches covered.">        for (String key : linkedTreeMap.keySet()) {</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">            if (key.startsWith(CompositionSerializer.TAG_CONTENT)) contents.add(linkedTreeMap.get(key));</span>
<span class="fc" id="L183">        }</span>

<span class="fc" id="L185">        return contents;</span>
    }

    public LinkedTreeMap removeContents() {
<span class="fc" id="L189">        LinkedTreeMap retMap = new LinkedTreeMap();</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">        for (String key : linkedTreeMap.keySet()) {</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">            if (!key.startsWith(CompositionSerializer.TAG_CONTENT)) retMap.put(key, linkedTreeMap.get(key));</span>
<span class="fc" id="L192">        }</span>
<span class="fc" id="L193">        return retMap;</span>
    }

    public LinkedTreeMap removeDuplicateArchetypeNodeId() {
<span class="fc" id="L197">        LinkedTreeMap retMap = new LinkedTreeMap();</span>
<span class="fc" id="L198">        retMap.putAll(linkedTreeMap);</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">        if (linkedTreeMap.containsKey(I_DvTypeAdapter.ARCHETYPE_NODE_ID)</span>
<span class="fc bfc" id="L200" title="All 2 branches covered.">                &amp;&amp; linkedTreeMap.containsKey(CompositionSerializer.TAG_ARCHETYPE_NODE_ID))</span>
<span class="fc" id="L201">            retMap.remove(CompositionSerializer.TAG_ARCHETYPE_NODE_ID);</span>
<span class="fc" id="L202">        return retMap;</span>
    }

    private boolean containsKeyStartingWith(String key) {
<span class="fc" id="L206">        return linkedTreeMap.keySet().stream()</span>
<span class="fc" id="L207">                        .filter(s -&gt; s.startsWith(key))</span>
<span class="fc" id="L208">                        .collect(Collectors.toSet())</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">                        .size()</span>
                &gt; 0;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>